{"version":3,"file":"coin98_telegram_payment.cjs.development.js","sources":["../src/packages/core.ts"],"sourcesContent":["import { Bot } from \"grammy\";\nimport { get } from \"lodash-es\";\nimport { RequestPaymentParams } from \"../types\";\n\nexport class Coin98Payment{\n  private bot: Bot\n  //recommend use db for production\n  private paidUsers: Map<number, string>;\n\n  constructor(tokenId: string){\n    this.bot = new Bot(tokenId );\n    this.paidUsers = new Map<number, string>()\n  }\n\n  async sendInvoice(params: RequestPaymentParams){\n    const { chatId, product, others } = params\n\n    try {\n        const message = await this.bot.api.sendInvoice(chatId,\n            get(product, 'title'),\n            get(product, 'description'),\n            get(product, 'payload', ''),\n            get(product, 'currency'),\n            get(product, 'variants'),\n            others\n        )\n\n        return message\n    } catch (error) {\n        throw new Error(error as unknown as string)\n    }\n  }\n\n  queryPreCheckout(){\n    this.bot.on(\"pre_checkout_query\", async (ctx) => {\n        try {\n            return await ctx.answerPreCheckoutQuery(true);\n        } catch(error) {\n            throw new Error(error as unknown as string)\n        }\n    });\n  }\n\n  onPaymentSuccessful(){\n    this.bot.on(\"message:successful_payment\", (ctx) => {\n        //send notification\n\n        if (!ctx.message || !ctx.message.successful_payment || !ctx.from) {\n          return;\n        }\n      \n        this.paidUsers.set(\n          ctx.from.id,\n          ctx.message.successful_payment.telegram_payment_charge_id,\n        );\n    });\n  }\n\n  checkStatusPayment(){\n    this.bot.command(\"status\", (ctx) => {\n        const message = this.paidUsers.has(get(ctx, 'from.id') as number)\n          ? \"You have paid\"\n          : \"You have not paid yet\";\n        return ctx.reply(message);\n      });\n  }\n}"],"names":["Coin98Payment","tokenId","bot","Bot","paidUsers","Map","_proto","prototype","sendInvoice","_sendInvoice","_asyncToGenerator","_regeneratorRuntime","mark","_callee","params","chatId","product","others","message","wrap","_callee$","_context","prev","next","api","get","sent","abrupt","t0","Error","stop","_x","apply","arguments","queryPreCheckout","on","_ref","_callee2","ctx","_callee2$","_context2","answerPreCheckoutQuery","_x2","onPaymentSuccessful","successful_payment","from","_this","set","id","telegram_payment_charge_id","checkStatusPayment","command","_this2","has","reply"],"mappings":"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"}